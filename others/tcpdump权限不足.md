# tcpdump权限不足

## 起因

原本想在服务器上抓抓请求的来源ip，但是由于对提取ip的方式不熟悉，所以就想使用本地的wireshark来直观的做这件事情。

步骤

- 使用tcpdump抓指定量的数据包
- copy 数据包到办公电脑

想简单使用`scp`来拷贝数据包，但执行过程中`scp`看上去被禁用了，之后在使用tcpdump的时候发现不能使用-r来读取文件了，报权限不足。尝试使用root用户之后还是这个样子，右反复检查文件权限，退出shell重新打开，就差重启服务器了。因为服务器时生产环境不能随便重启，所以就很纳闷，到底发生了什么？

## 解决

查阅了资料，发现[这篇文章](https://bbs.huaweicloud.com/forum.php?mod=viewthread&tid=108311&extra=&ordertype=1) 可以解决了这个问题，可以正常使用tcpdump。当时的现象是tcpdump使用root用户可以正常抓包，但是不能读取保存下来的文件。和网上的觉大多数现象其实还有点不一样，他们大部分都是连抓包都没有权限。

解决方法里使用`apparmor-utilsz`这个包，将tcpdump设置为Complain模式，就可以了。apparmor是Linux内核的一个安全模块，允许系统管理员将每个程序与一个安全配置文件关联，从而限制程序的功能。

有两种模式

- Enforcement – 在这种模式下，配置文件里列出的限制条件都会得到执行，并且对于违反这些限制条件的程序会进行日志记录。
- Complain – 在这种模式下，配置文件里的限制条件不会得到执行，Apparmor只是对程序的行为进行记录。例如程序可以写一个在配置文件里注明只读的文件，但Apparmor不会对程序的行为进行限制，只是进行记录。

## 原因

仔细回想了一下当时的操作

- 可以正常使用tcpdump来抓包和读取抓包文件
- 使用scp命令卡住，没有执行成功
- 可以使用tcpdump抓包，但是不能读取抓包文件

看上去是运维限制scp命令之后，触发了某些机制，而导致tcpdump不能像刚开始一样运行

具体原因，得知道运维是怎么限制scp的，之前限制远程拷贝的方式是直接粗暴的设置shell禁止打某些特定关键词，而导致某些随机生成的pod的名字，都没法复制。现在看上去也是这种方式也是有坑？

## 后续

当然可能你想问，没有使用wireshark有提取出来来源ip吗？当然这也是一个机会去熟悉linux命令，awk 还真是小型编程语言，还挺万能



